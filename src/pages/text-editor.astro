---
import Layout from '~/layouts/PageLayout.astro';
import TextEditorComponent from '~/components/blog/textEditor.astro';

const metadata = {
  title: 'Blog Post Editor',
  description: 'Create and publish blog posts with markdown editor',
};
---

<Layout metadata={metadata}>
  <main class="px-4 py-8">
    <div class="mx-auto max-w-6xl">
      <div class="mb-8">
        <h1 class="mb-4 text-3xl font-bold !leading-tight text-gray-900 dark:text-white">Blog Post Editor</h1>
        <p class="text-gray-600">Create and publish blog posts with frontmatter and markdown content.</p>
      </div>

      <div class="rounded-lg bg-white p-6 shadow-lg">
        <div class="mb-6 grid grid-cols-1 gap-4 md:grid-cols-2">
          <div>
            <label for="post-title" class="mb-2 block text-sm font-medium text-gray-700"> Title </label>
            <input
              type="text"
              id="post-title"
              placeholder="Enter post title..."
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            />
          </div>

          <div>
            <label for="post-description" class="mb-2 block text-sm font-medium text-gray-700"> Excerpt </label>
            <input
              type="text"
              id="post-description"
              placeholder="Enter post excerpt..."
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            />
          </div>

          <div>
            <label for="post-tags" class="mb-2 block text-sm font-medium text-gray-700"> Tags (comma-separated) </label>
            <input
              type="text"
              id="post-tags"
              placeholder="tag1, tag2, tag3"
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            />
          </div>

          <div>
            <label for="post-category" class="mb-2 block text-sm font-medium text-gray-700"> Category </label>
            <input
              type="text"
              id="post-category"
              placeholder="Enter category..."
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            />
          </div>

          <div>
            <label for="post-author" class="mb-2 block text-sm font-medium text-gray-700"> Author </label>
            <input
              type="text"
              id="post-author"
              placeholder="Enter author name..."
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            />
          </div>

          <div>
            <label for="post-image" class="mb-2 block text-sm font-medium text-gray-700"> Featured Image URL </label>
            <input
              type="url"
              id="post-image"
              placeholder="https://example.com/image.jpg"
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            />
          </div>
        </div>

        <div class="mb-6">
          <label class="mb-2 block text-sm font-medium text-gray-700"> Content </label>
          <TextEditorComponent
            height="500px"
            initialValue="# Your Blog Post Title\n\nStart writing your blog post content here..."
            placeholder="Write your blog post content in markdown..."
            id="blog-editor"
          />
        </div>

        <div class="flex gap-4">
          <button
            onclick="saveBlogPost()"
            class="rounded-md bg-blue-600 px-6 py-2 font-medium text-white transition-colors hover:bg-blue-700"
          >
            Save Blog Post
          </button>

          <button
            onclick="previewPost()"
            class="rounded-md bg-green-600 px-6 py-2 font-medium text-white transition-colors hover:bg-green-700"
          >
            Preview
          </button>

          <button
            onclick="clearForm()"
            class="rounded-md bg-red-600 px-6 py-2 font-medium text-white transition-colors hover:bg-red-700"
          >
            Clear All
          </button>
        </div>
      </div>

      <div id="preview-container" class="mt-8 hidden rounded-lg bg-gray-50 p-6 dark:bg-gray-900">
        <h3 class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Blog Post Preview:</h3>
        <div class="rounded-lg border bg-white p-6 dark:bg-gray-800">
          <div id="preview-frontmatter" class="mb-4 rounded bg-gray-100 p-4 font-mono text-sm dark:bg-gray-700"></div>
          <div id="preview-content" class="prose max-w-none dark:prose-invert"></div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  function generateSlug(title) {
    return title
      .toLowerCase()
      .replace(/[^a-z0-9\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .trim();
  }

  function formatDate(date) {
    return date.toISOString().split('T')[0];
  }

  function generateBlogPost() {
    const title = document.getElementById('post-title').value.trim();
    const description = document.getElementById('post-description').value.trim();
    const tags = document.getElementById('post-tags').value.trim();
    const category = document.getElementById('post-category').value.trim();
    const author = document.getElementById('post-author').value.trim();
    const image = document.getElementById('post-image').value.trim();
    const content = window.getEditorContent('blog-editor');

    if (!title || !content) {
      alert('Please provide at least a title and content for your blog post.');
      return null;
    }

    const slug = generateSlug(title);
    const publishDate = new Date().toISOString();
    const tagsArray = tags
      ? tags
          .split(',')
          .map((tag) => tag.trim())
          .filter((tag) => tag)
      : [];

    const frontmatter = {
      title: title,
      excerpt: description || '',
      publishDate: publishDate,
      draft: false,
      ...(tagsArray.length > 0 && { tags: tagsArray }),
      ...(category && { category }),
      ...(author && { author }),
      ...(image && { image }),
      metadata: {
        description: description || '',
        title: title,
      },
    };

    const frontmatterString = Object.entries(frontmatter)
      .map(([key, value]) => {
        if (key === 'publishDate') {
          return `${key}: ${value}`;
        } else if (Array.isArray(value)) {
          return `${key}: [${value.map((v) => `"${v}"`).join(', ')}]`;
        } else if (typeof value === 'object') {
          return `${key}:\n  ${Object.entries(value)
            .map(([k, v]) => `${k}: "${v}"`)
            .join('\n  ')}`;
        } else if (typeof value === 'string') {
          return `${key}: "${value}"`;
        } else {
          return `${key}: ${value}`;
        }
      })
      .join('\n');

    const blogPost = `---\n${frontmatterString}\n---\n\n${content}`;

    return {
      slug,
      content: blogPost,
      frontmatter,
      markdownContent: content,
    };
  }

  async function saveBlogPost() {
    debugger;
    const title = document.getElementById('post-title').value.trim();
    const description = document.getElementById('post-description').value.trim();
    const tags = document.getElementById('post-tags').value.trim();
    const category = document.getElementById('post-category').value.trim();
    const author = document.getElementById('post-author').value.trim();
    const image = document.getElementById('post-image').value.trim();
    const content = window.getEditorContent('blog-editor');

    if (!title || !content) {
      alert('Please provide at least a title and content for your blog post.');
      return;
    }

    const saveButton = document.querySelector('button[onclick="saveBlogPost()"]');
    const originalText = saveButton.textContent;
    saveButton.textContent = 'Saving...';
    saveButton.disabled = true;

    try {
      const response = await fetch('/api/blog', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          title,
          description,
          tags,
          category,
          author,
          image,
          content,
        }),
      });

      const result = await response.json();

      if (response.ok) {
        alert(`Blog post saved successfully!\n\nFilename: ${result.filename}\nLocation: ${result.filepath}`);
        console.log('Blog post created:', result);

        clearForm();
      } else {
        alert(`Error: ${result.error}`);
      }
    } catch (error) {
      console.error('Error saving blog post:', error);
      alert('Error saving blog post. Please check your connection and try again.');
    } finally {
      saveButton.textContent = originalText;
      saveButton.disabled = false;
    }
  }

  function previewPost() {
    const blogPost = generateBlogPost();
    if (!blogPost) return;

    const previewContainer = document.getElementById('preview-container');
    const frontmatterDiv = document.getElementById('preview-frontmatter');
    const contentDiv = document.getElementById('preview-content');

    const frontmatterString = Object.entries(blogPost.frontmatter)
      .map(([key, value]) => {
        if (key === 'publishDate') {
          return `${key}: ${value}`;
        } else if (Array.isArray(value)) {
          return `${key}: [${value.map((v) => `"${v}"`).join(', ')}]`;
        } else if (typeof value === 'object') {
          return `${key}:\n  ${Object.entries(value)
            .map(([k, v]) => `${k}: "${v}"`)
            .join('\n  ')}`;
        } else if (typeof value === 'string') {
          return `${key}: "${value}"`;
        } else {
          return `${key}: ${value}`;
        }
      })
      .join('\n');

    frontmatterDiv.textContent = `---\n${frontmatterString}\n---`;
    contentDiv.innerHTML = window.getEditorHTML('blog-editor');

    previewContainer.classList.remove('hidden');
    previewContainer.scrollIntoView({ behavior: 'smooth' });
  }

  function clearForm() {
    document.getElementById('post-title').value = '';
    document.getElementById('post-description').value = '';
    document.getElementById('post-tags').value = '';
    document.getElementById('post-category').value = '';
    document.getElementById('post-author').value = '';
    document.getElementById('post-image').value = '';
    window.clearEditor('blog-editor');

    const previewContainer = document.getElementById('preview-container');
    previewContainer.classList.add('hidden');
  }

  function exportBlogPost() {
    const blogPost = generateBlogPost();
    if (!blogPost) return;

    const blob = new Blob([blogPost.content], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${blogPost.slug}.md`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const exportButton = document.createElement('button');
    exportButton.textContent = 'Export as .md';
    exportButton.onclick = exportBlogPost;
    exportButton.className =
      'bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-md transition-colors font-medium';

    const buttonContainer = document.querySelector('.flex.gap-4');
    if (buttonContainer) {
      buttonContainer.appendChild(exportButton);
    }
  });

  window.saveBlogPost = saveBlogPost;
  window.previewPost = previewPost;
  window.clearForm = clearForm;
  window.exportBlogPost = exportBlogPost;
</script>
